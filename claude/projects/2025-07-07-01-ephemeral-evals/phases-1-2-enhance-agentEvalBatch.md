# Enhanced AgentEvalBatch Implementation Strategy

## Executive Summary

This document outlines the first two phases of implementing enhanced evaluation capabilities in RoastMyPost. These phases focus on extending the existing `AgentEvalBatch` system to support specific document selection and improving the UI for better test control.

These enhancements lay the foundation for more advanced ephemeral evaluation features described in [2025-07-07-02-ephemeral-batch-implementation.md](./2025-07-07-02-ephemeral-batch-implementation.md).

## Phase 1: Enhanced AgentEvalBatch (1-2 days)

### Goal

Extend `AgentEvalBatch` to support specific document selection instead of only random selection via `targetCount`.

### Implementation

#### 1.1 API Changes

```typescript
// POST /api/agents/[agentId]/eval-batch
interface CreateBatchRequest {
  name?: string;

  // NEW: Specific document selection
  documentIds?: string[];

  // Random selection (mostly deprecated in favor of documentIds)
  targetCount?: number;
}

// Response
interface CreateBatchResponse {
  batch: {
    id: string;
    name: string;
    agentId: string;
    createdAt: string;
    targetCount: number; // Total evaluations created
    documentIds: string[]; // Documents included
    jobCount: number; // Jobs created
  };
  jobs: Array<{
    id: string;
    documentId: string;
    status: "PENDING";
  }>;
}
```

#### 1.2 Validation Logic

```typescript
async function validateBatchRequest(body: CreateBatchRequest) {
  // Mutual exclusivity
  if (body.documentIds && body.targetCount) {
    throw new Error("Cannot specify both documentIds and targetCount");
  }

  if (!body.documentIds && !body.targetCount) {
    throw new Error("Must specify either documentIds or targetCount");
  }

  // TODO: Don't allow repeats, for now
  // Document validation
  if (body.documentIds) {
    const docs = await prisma.document.findMany({
      where: { id: { in: body.documentIds } },
      select: { id: true },
    });

    const foundIds = new Set(docs.map((d) => d.id));
    const missing = body.documentIds.filter((id) => !foundIds.has(id));

    if (missing.length > 0) {
      throw new Error(`Documents not found: ${missing.join(", ")}`);
    }
  }
}
```

#### 1.3 Database Migration

##### Prisma Schema Changes

```prisma
model AgentEvalBatch {
  id                   String         @id @default(cuid())
  name                 String?
  agentId              String
  targetCount          Int
  createdAt            DateTime       @default(now())

  // NEW: Track specific documents requested for this batch
  requestedDocumentIds String[]       @default([])

  agent                Agent          @relation(fields: [agentId], references: [id])
  jobs                 Job[]

  @@index([agentId])
}
```

##### Migration SQL (generated by Prisma)

```sql
-- AlterTable
ALTER TABLE "AgentEvalBatch" ADD COLUMN "requestedDocumentIds" TEXT[] DEFAULT ARRAY[]::TEXT[];
```

#### 1.4 Usage Examples

```bash
# Test agent on specific documents
curl -X POST /api/agents/advisor-v1/eval-batch \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Testing advisor on edge cases",
    "documentIds": ["doc-1", "doc-2", "doc-3"],
    "options": {
      "repeatCount": 3,
      "shuffle": true
    }
  }'

# Backwards compatible: random selection
curl -X POST /api/agents/advisor-v1/eval-batch \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Random sample test",
    "targetCount": 20
  }'
```

### Benefits

- Precise control over test documents
- Reproducible test sets
- Backwards compatible
- Foundation for ephemeral experiments

## Phase 2: UI Updates for Test Tab (1 day)

### Goal

Update the agent Test tab UI to support selecting specific documents instead of just a random count.

### Implementation

#### 2.1 Current UI State

The Test tab currently shows:

- Test Name field (optional)
- Number of Evaluations dropdown (targetCount)

#### 2.2 New UI Design

Replace the "Number of Evaluations" dropdown with a document selection interface:

```typescript
interface TestFormState {
  name?: string;

  // Selection mode toggle
  selectionMode: "specific" | "random";

  // For specific selection
  documentIds?: string[];

  // For random selection (backwards compatible)
  targetCount?: number;
}
```

#### 2.3 UI Components

1. **Selection Mode Toggle**

   - Radio buttons or tabs: "Select Specific Documents" vs "Random Selection"

2. **Document Selector (for specific mode)**

   - Multi-select dropdown or searchable list
   - Show documents that have been previously evaluated by this agent
   - Display document title, author, and last evaluation date
   - Allow selecting/deselecting multiple documents

3. **Random Selection (for backwards compatibility)**
   - Keep existing dropdown for number of evaluations
   - Only shown when "Random Selection" mode is active

#### 2.4 Files to Edit

```
src/components/AgentDetail/tabs/
├── TestTab.tsx              # Main test tab component (exists)
└── DocumentSelector.tsx     # New component for document selection

src/app/api/agents/[agentId]/eval-batch/
└── route.ts                 # API endpoint updates

src/lib/
├── schemas/
│   └── agent-batch.ts       # Zod schemas for validation
└── api/
    └── agents.ts            # Client-side API functions
```

#### 2.5 Component Implementation

```tsx
// DocumentSelector.tsx
interface DocumentSelectorProps {
  agentId: string;
  selectedIds: string[];
  onChange: (ids: string[]) => void;
}

function DocumentSelector({
  agentId,
  selectedIds,
  onChange,
}: DocumentSelectorProps) {
  // Fetch documents that have been evaluated by this agent
  const { data: documents } = useQuery({
    queryKey: ["agent-documents", agentId],
    queryFn: () => fetchAgentEvaluatedDocuments(agentId),
  });

  return (
    <div className="space-y-2">
      <label className="text-sm font-medium">Select Documents to Test</label>
      <MultiSelect
        options={documents?.map((doc) => ({
          value: doc.id,
          label: doc.title,
          description: `by ${doc.author} • Last evaluated: ${formatDate(doc.lastEvaluatedAt)}`,
        }))}
        value={selectedIds}
        onChange={onChange}
        placeholder="Search and select documents..."
      />
      <p className="text-sm text-gray-500">
        Selected: {selectedIds.length} document
        {selectedIds.length !== 1 ? "s" : ""}
      </p>
    </div>
  );
}
```

### Benefits

- Better UX for targeted testing
- Maintains backwards compatibility
- Sets foundation for ephemeral experiments

## Next Steps

With these foundational enhancements in place, the next phases focus on:

- **Phase 3**: EphemeralBatch implementation for temporary experiments
- **Phase 4**: Export & Import system for sharing configurations

See [2025-07-07-02-ephemeral-batch-implementation.md](./2025-07-07-02-ephemeral-batch-implementation.md) for the complete ephemeral evaluation strategy.
